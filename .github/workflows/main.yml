name: Deploy Blazor WASM to gh-pages

on:
  push:
    branches:
      - master
    paths:
      - 'BirthdayPokemonWeb/**'
  workflow_dispatch:

permissions:
  contents: write

# CONFIGURATION SECTION (easy to edit)
env:
  PROJECT_PATH: BirthdayPokemonWeb/BirthdayPokemonWeb.csproj
  OUTPUT_DIR: out
  WWWROOT_DIR: out/wwwroot

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # required for pushing changes

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0'

      - name: Compute base href dynamically
        id: basehref
        run: |
          REPO_NAME=$(basename $(git rev-parse --show-toplevel))
          if [ "${GITHUB_REF_NAME}" = "master" ]; then
            BASE="/${REPO_NAME}/"
          else
            BASE="/${REPO_NAME}/${GITHUB_REF_NAME}/"
          fi
          echo "base_href=$BASE" >> $GITHUB_OUTPUT

      - name: Publish Blazor WebAssembly
        run: |
          dotnet publish "$PROJECT_PATH" -c Release -o "$OUTPUT_DIR"

      - name: Rewrite base href in index.html
        uses: SteveSandersonMS/ghaction-rewrite-base-href@v1.1.0
        with:
          html_path: ${{ env.WWWROOT_DIR }}/index.html
          base_href: ${{ steps.basehref.outputs.base_href }}

      # Deploy to gh-pages while keeping commit history
      - name: Deploy to gh-pages branch (keep history)
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.WWWROOT_DIR }}
          publish_branch: gh-pages
          # no force_orphan → keeps meaningful history
          commit_message: "Deploy from ${GITHUB_REF_NAME} (${GITHUB_SHA})"
